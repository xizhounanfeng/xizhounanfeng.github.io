<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智链抽奖引擎要点 | 西洲南风</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="https://jsd.onmicrosoft.cn/gh/xizhounanfeng/blogImg/images/lion-logo.jpg">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3077305_pt8umhrn4k9.css">
    <meta name="description" content="">
    <meta name="keywords" content="自定义网站关键词">
    
    <link rel="preload" href="/assets/css/0.styles.bb28faf8.css" as="style"><link rel="preload" href="/assets/js/app.fc6a2803.js" as="script"><link rel="preload" href="/assets/js/2.5f34bf74.js" as="script"><link rel="preload" href="/assets/js/18.8e205241.js" as="script"><link rel="preload" href="/assets/js/8.3f2feba3.js" as="script"><link rel="prefetch" href="/assets/js/10.b4cebaac.js"><link rel="prefetch" href="/assets/js/11.1d259798.js"><link rel="prefetch" href="/assets/js/12.fbdb1bb5.js"><link rel="prefetch" href="/assets/js/13.a9d2103e.js"><link rel="prefetch" href="/assets/js/14.207b58ff.js"><link rel="prefetch" href="/assets/js/15.1823a6ad.js"><link rel="prefetch" href="/assets/js/16.7b5662c3.js"><link rel="prefetch" href="/assets/js/17.c97a18eb.js"><link rel="prefetch" href="/assets/js/19.70e28d4d.js"><link rel="prefetch" href="/assets/js/3.f0a33886.js"><link rel="prefetch" href="/assets/js/4.0e58caee.js"><link rel="prefetch" href="/assets/js/5.17ae97fa.js"><link rel="prefetch" href="/assets/js/6.b7a3db7d.js"><link rel="prefetch" href="/assets/js/7.f6b4ca36.js"><link rel="prefetch" href="/assets/js/9.c2c4cfc1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bb28faf8.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://jsd.onmicrosoft.cn/gh/xizhounanfeng/blogImg/images/lion-logo.jpg" alt="西洲南风" class="logo"> <span class="site-name can-hide">西洲南风</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title" style="display:;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/bad9a3/" class="nav-link">MySQL</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/b7b397/404" class="nav-link">NoSQL数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring全家桶" class="dropdown-title"><!----> <span class="title" style="display:;">Spring全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/e873cb/" class="nav-link">SpringCloud系列</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实战项目" class="dropdown-title"><!----> <span class="title" style="display:;">实战项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b7b397/" aria-current="page" class="nav-link router-link-exact-active router-link-active">智链抽奖引擎</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title" style="display:;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/bad9a3/" class="nav-link">MySQL</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/b7b397/404" class="nav-link">NoSQL数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring全家桶" class="dropdown-title"><!----> <span class="title" style="display:;">Spring全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/e873cb/" class="nav-link">SpringCloud系列</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实战项目" class="dropdown-title"><!----> <span class="title" style="display:;">实战项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b7b397/" aria-current="page" class="nav-link router-link-exact-active router-link-active">智链抽奖引擎</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>智链抽奖引擎</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b7b397/" aria-current="page" class="active sidebar-link">智链抽奖引擎要点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/b7b397/#抽奖流程抽象设计" class="sidebar-link">抽奖流程抽象设计</a></li><li class="sidebar-sub-header level2"><a href="/pages/b7b397/#库表及索引设计" class="sidebar-link">库表及索引设计</a></li><li class="sidebar-sub-header level2"><a href="/pages/b7b397/#抽奖算法设计" class="sidebar-link">抽奖算法设计</a></li><li class="sidebar-sub-header level2"><a href="/pages/b7b397/#权重策略处理" class="sidebar-link">权重策略处理</a></li><li class="sidebar-sub-header level2"><a href="/pages/b7b397/#责任链模式处理抽奖" class="sidebar-link">责任链模式处理抽奖</a></li><li class="sidebar-sub-header level2"><a href="/pages/b7b397/#规则引擎处理抽奖" class="sidebar-link">规则引擎处理抽奖</a></li><li class="sidebar-sub-header level2"><a href="/pages/b7b397/#滑块锁设计" class="sidebar-link">滑块锁设计</a></li><li class="sidebar-sub-header level2"><a href="/pages/b7b397/#异步更新库存" class="sidebar-link">异步更新库存</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>实战项目</span></li><li data-v-06225672><span data-v-06225672>智链抽奖引擎</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>西洲南风</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-04-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">智链抽奖引擎要点<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="抽奖流程抽象设计"><a href="#抽奖流程抽象设计" class="header-anchor">#</a> 抽奖流程抽象设计</h2> <ul><li>简历描述：深入研究PRD文档和相关功能需求，将复杂的抽奖流程精准拆解为抽奖前、中、后三个关键节点，方便在各个节点扩展各类行为动作</li></ul> <div class="custom-block tip"><p class="custom-block-title">面试提问</p> <p>把抽奖划分为抽奖前、中、后，三个动作。请具体结合场景讲解下，为什么这样设计？</p></div> <ul><li>这个的设计得益于在 Spring/MyBatis 框架源码的学习，在源码中经常会出现对一个流程进行拆分解耦，流程可扩展的点，如 Spring 是 Bean 对象的拆解，MyBatis 是会话流程的拆解</li> <li>所以在设计抽奖模块时，对于需求中的各类功能点：<code>黑名单抽奖、权重抽奖、默认抽奖、抽奖N次解锁、兜底抽奖</code>等等情况，是可以拆解为抽奖前、中、后3个行为动作的。基于这样的考虑后，就可以设计出非常容易扩展的松耦合结构</li></ul> <h2 id="库表及索引设计"><a href="#库表及索引设计" class="header-anchor">#</a> 库表及索引设计</h2> <ul><li><p>简历描述：设计抽奖库表及相关索引，抽象抽奖过程为抽奖策略表、策略明细表、规则配置表、规则树动作表，方便抽奖扩展</p></li> <li><p>背景：抽奖如果不添加各项手段的情况下，单一玩法的可操作性是比较低的。所以添加了随机积分、运气值、抽奖解锁的相关功能</p></li> <li><p>奖品表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>award<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖奖品ID - 内部流转使用'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_key<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'奖品对接标识 - 每一个都是一个对应的发奖策略'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_config<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'奖品配置信息'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_desc<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'奖品内容描述'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>抽奖策略表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>strategy<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>strategy_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖策略ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>strategy_desc<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖策略描述'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_models<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则模型，rule配置的模型同步到此表，便于使用'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_strategy_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>strategy_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>策略明细表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>strategy_award<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>strategy_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖策略ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖奖品ID - 内部流转使用'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_title<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖奖品标题'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_subtitle<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖奖品副标题'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'奖品库存总量'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_count_surplus<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'奖品库存剩余'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_rate<span class="token punctuation">`</span></span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'奖品中奖概率'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_models<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则模型，rule配置的模型同步到此表，便于使用'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>sort<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'排序'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_strategy_id_award_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>strategy_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>award_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li> <li><p>规则配置表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>strategy_rule<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>strategy_id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖策略ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>award_id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖奖品ID【规则类型为策略，则不需要奖品ID】'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_type<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽象规则类型；1-策略规则、2-奖品规则'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_model<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖规则类型【rule_random - 随机值计算、rule_lock - 抽奖几次后解锁、rule_luck_award - 幸运奖(兜底奖品)】'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_value<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖规则比值'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_desc<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'抽奖规则描述'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_strategy_id_award_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>strategy_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>award_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>规则树动作表</p> <ul><li><p>规则树表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>rule_tree<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tree_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则树ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tree_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则树名称'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tree_desc<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则树描述'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tree_node_rule_key<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则树根入口规则'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uq_tree_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tree_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>规则树节点表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>rule_tree_node<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tree_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则树ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_key<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则Key'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_desc<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则描述'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_value<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则比值'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>规则树节点线表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>rule_tree_node_line<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tree_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则树ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_node_from<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则Key节点 From'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_node_to<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规则Key节点 To'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_limit_type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'限定类型；1:=;2:&gt;;3:&lt;;4:&gt;=;5&lt;=;6:enum[枚举范围];'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rule_limit_value<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'限定值（到下个节点）'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ul></li></ul> <h2 id="抽奖算法设计"><a href="#抽奖算法设计" class="header-anchor">#</a> 抽奖算法设计</h2> <ul><li>简历描述：设计抽奖算法完成抽奖策略的装配工作，这包括奖品整体概率和权重概率的精确计算与配置，确保每次抽奖结果的公平性和随机性</li> <li>抽奖算法</li></ul> <p><img src="https://jsd.onmicrosoft.cn/gh/xizhounanfeng/blogImg/first.jpg" alt=""></p> <ul><li><p>循环对比【复杂度为O(N)】</p> <ul><li><p>根据概率值，来创建出累加的范围</p> <ul><li>比如：A是占10个，B的范围则是从10+40到50个。依次类推</li></ul></li> <li><p>抽奖活动的随机值，可以在这些区间内循环对比</p></li> <li><p>具体实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 获取随机概率值</span>
<span class="token class-name">SecureRandom</span> secureRandom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> randomVal <span class="token operator">=</span> secureRandom<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// 循环获取奖品</span>
<span class="token class-name">String</span> awardId <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> cursorVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AwardRateInfo</span> awardRateInfo <span class="token operator">:</span> differenceAwardRateList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> rateVal <span class="token operator">=</span> awardRateInfo<span class="token punctuation">.</span><span class="token function">getAwardRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>differenceDenominator<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ROUND_UP</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>randomVal <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>cursorVal <span class="token operator">+</span> rateVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		awardId <span class="token operator">=</span> awardRateInfo<span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cursorVal <span class="token operator">+=</span> rateVal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回中奖结果</span>
<span class="token keyword">return</span> awardId<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li></ul></li> <li><p>索引获取【复杂度O(1)】</p> <ul><li><p>存放到Map中【<code>空间换时间</code>】</p></li> <li><p>抽奖时，把随机值当索引使用，可以直接获取到对应的奖品结果</p></li> <li><p>具体实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token comment">/**
     * 计算公式；
     * 1. 找到范围内最小的概率值，比如 0.1、0.02、0.003，需要找到的值是 0.003
     * 2. 基于1找到的最小值，0.003 就可以计算出百分比、千分比的整数值。这里就是1000
     * 3. 那么「概率 * 1000」分别占比100个、20个、3个，总计是123个
     * 4. 后续的抽奖就用123作为随机数的范围值，生成的值100个都是0.1概率的奖品、20个是概率0.02的奖品、最后是3个是0.003的奖品。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">assembleLotteryStrategy</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StrategyAwardEntity</span><span class="token punctuation">&gt;</span></span> strategyAwardEntities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 获取最小概率值</span>
        <span class="token class-name">BigDecimal</span> minAwardRate <span class="token operator">=</span> strategyAwardEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">StrategyAwardEntity</span><span class="token operator">::</span><span class="token function">getAwardRate</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token operator">::</span><span class="token function">compareTo</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 循环计算找到概率范围值</span>
        <span class="token class-name">BigDecimal</span> rateRange <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token function">convert</span><span class="token punctuation">(</span>minAwardRate<span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 生成策略奖品概率查找表「这里指需要在list集合中，存放上对应的奖品占位即可，占位越多等于概率越高」</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> strategyAwardSearchRateTables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>rateRange<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StrategyAwardEntity</span> strategyAward <span class="token operator">:</span> strategyAwardEntities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Integer</span> awardId <span class="token operator">=</span> strategyAward<span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BigDecimal</span> awardRate <span class="token operator">=</span> strategyAward<span class="token punctuation">.</span><span class="token function">getAwardRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 计算出每个概率值需要存放到查找表的数量，循环填充</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rateRange<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>awardRate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                strategyAwardSearchRateTables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>awardId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 4. 对存储的奖品进行乱序操作</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span>strategyAwardSearchRateTables<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 生成出Map集合，key值，对应的就是后续的概率值。通过概率来获得对应的奖品ID</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> shuffleStrategyAwardSearchRateTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> strategyAwardSearchRateTables<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            shuffleStrategyAwardSearchRateTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> strategyAwardSearchRateTables<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6. 存放到 Redis</span>
        repository<span class="token punctuation">.</span><span class="token function">storeStrategyAwardSearchRateTable</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> shuffleStrategyAwardSearchRateTable<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shuffleStrategyAwardSearchRateTable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">/**
     * 转换计算，只根据小数位来计算。如【0.01返回100】、【0.009返回1000】、【0.0018返回10000】
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token keyword">double</span> min<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> current <span class="token operator">=</span> min<span class="token punctuation">;</span>
        <span class="token keyword">double</span> max <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>current <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            current <span class="token operator">=</span> current <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
            max <span class="token operator">=</span> max <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> max<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div></li></ul></li></ul> <h2 id="权重策略处理"><a href="#权重策略处理" class="header-anchor">#</a> 权重策略处理</h2> <ul><li><p>简历描述：增强抽奖策略装配，实现权重策略的处理，用于满足抽奖中支持不同阶梯所能抽奖范围的处理</p></li> <li><p>背景：需要满足用户抽奖N积分后，可中奖范围的设定【必中奖】</p> <ul><li>举例：你总共消耗了6000积分抽奖，那么接下来的抽奖就会有圈定到固定的奖品范围，不会让用户再抽到过低价值的奖品</li></ul></li> <li><p>装配由原本的整体概率装配，扩展为支持权重装配</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">assembleLotteryStrategy</span><span class="token punctuation">(</span><span class="token class-name">Long</span> strategyId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 查询策略配置</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StrategyAwardEntity</span><span class="token punctuation">&gt;</span></span> strategyAwardEntities <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">queryStrategyAwardList</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2 缓存奖品库存【用于decr扣减库存使用】</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StrategyAwardEntity</span> strategyAward <span class="token operator">:</span> strategyAwardEntities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Integer</span> awardId <span class="token operator">=</span> strategyAward<span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Integer</span> awardCount <span class="token operator">=</span> strategyAward<span class="token punctuation">.</span><span class="token function">getAwardCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">cacheStrategyAwardCount</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">,</span> awardId<span class="token punctuation">,</span> awardCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3.1 默认装配配置【全量抽奖概率】</span>
        <span class="token function">assembleLotteryStrategy</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">)</span><span class="token punctuation">,</span> strategyAwardEntities<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.2 权重策略配置 - 适用于 rule_weight 权重规则配置【4000:102,103,104,105 5000:102,103,104,105,106,107 6000:102,103,104,105,106,107,108,109】</span>
        <span class="token class-name">StrategyEntity</span> strategyEntity <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">queryStrategyEntityByStrategyId</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> ruleWeight <span class="token operator">=</span> strategyEntity<span class="token punctuation">.</span><span class="token function">getRuleWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> ruleWeight<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token class-name">StrategyRuleEntity</span> strategyRuleEntity <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">queryStrategyRule</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">,</span> ruleWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 业务异常，策略规则中 rule_weight 权重规则已适用但未配置</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> strategyRuleEntity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AppException</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_RULE_WEIGHT_IS_NULL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_RULE_WEIGHT_IS_NULL</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ruleWeightValueMap <span class="token operator">=</span> strategyRuleEntity<span class="token punctuation">.</span><span class="token function">getRuleWeightValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> ruleWeightValueMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ruleWeightValues <span class="token operator">=</span> ruleWeightValueMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StrategyAwardEntity</span><span class="token punctuation">&gt;</span></span> strategyAwardEntitiesClone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>strategyAwardEntities<span class="token punctuation">)</span><span class="token punctuation">;</span>
            strategyAwardEntitiesClone<span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>entity <span class="token operator">-&gt;</span> <span class="token operator">!</span>ruleWeightValues<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assembleLotteryStrategy</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">UNDERLINE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> strategyAwardEntitiesClone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div></li></ul> <h2 id="责任链模式处理抽奖"><a href="#责任链模式处理抽奖" class="header-anchor">#</a> 责任链模式处理抽奖</h2> <ul><li><p>简历描述：针对抽奖流程中前置规则与抽奖行为相互交织导致的流程臃肿问题，采用责任链 + 工厂模式解耦抽奖规则中黑名单规则、权重规则等前置规则，使抽奖流程实现更加清晰、简洁</p></li> <li><p>背景：在之前的章节中，运用了策略模式、工厂模式、模板模式，来完成抽奖流程的定义和抽奖过程前、中、后，规则的过滤处理。在规则处理的流程中，因为前置规则的校验含带了抽奖的行为处理，这样绑定到规则流程实现中会显得有些臃肿，让规则负责的事情变得更多 --&gt; 使用责任链模式进行优化完善，让整个代码流程变得更加清晰</p></li> <li><p>设计：</p> <ul><li>抽奖的前置规则，在抽奖中可以被抽象为一种策略行为，比如；黑名单抽奖策略、权重抽奖策略、白名单抽奖策略等。而这些策略规则是一种互斥行为，比如走了黑名单规则，就不应该在继续走权重规则--&gt; 比较符合责任链的设计</li></ul></li> <li><p>实现：</p> <ul><li>抽象原有的抽奖前规则，为责任链处理</li> <li>责任链会顺序的将责任节点，通过责任链工厂，从库中读取到的责任节点进行顺序填充到责任链上
<ul><li>工厂方式可以更好的根据不同的策略创建出所需的责任链</li></ul></li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">面试提问</p> <p>什么场景下，使用责任链模式？为什么？</p></div> <ul><li>在设计完抽奖前、中、后，搜耦合的结构模型后，对于抽奖前要执行哪种抽奖，但单向选择的问题。所以这里使用了责任链模式，进行节点流程判断。从黑名单、权重，最后到默认，走一个单独的具体抽奖，所以使用责任链更为合适</li></ul> <h2 id="规则引擎处理抽奖"><a href="#规则引擎处理抽奖" class="header-anchor">#</a> 规则引擎处理抽奖</h2> <ul><li>简历描述：为解决抽奖流程中、后规则的流程执行和可扩展、可维护的问题，搭建了去中心化的量化规则引擎组件。通过组合模式的规则引擎，使得规则过滤节点以自由组合和多分支链路的方式完成抽奖流程的规则处理</li> <li>背景：为解决先阶段中抽奖策略规则的中、后两部分执行问题。通过组合模式的规则引擎，让过滤节点可以满足一颗二叉树的结构，自由的组合和多分支链路的方式完成流程的处理</li> <li>设计：
<ul><li>对于抽奖策略的<code>前置规则过滤</code>是顺序一条链的，有一个成功就可以返回。比如；黑名单抽奖、权重人群抽奖、默认抽奖，总之它只能有一种情况，所以这样的流程是适合责任链的</li> <li>对于<code>抽奖中到抽奖后的规则</code>，它是一个非多分支情况的规则过滤
<ul><li>单独的责任链是不能满足的</li> <li>如果是拆分开抽奖中规则和抽奖后规则分阶段处理，中间单独写逻辑处理库存操作
<ul><li>不够优雅，配置化的内容较低，后续的规则开发仍需要在代码上改造</li></ul></li></ul></li> <li>采用组合模式的决策树模型设计来完成</li></ul></li></ul> <p><img src="https://jsd.onmicrosoft.cn/gh/xizhounanfeng/blogImg/ruleTree.jpg" alt=""></p> <div class="custom-block tip"><p class="custom-block-title">面试提问1</p> <p>什么场景使用了组合模式？为什么？</p></div> <ul><li>进入抽奖流程的抽奖中和抽奖后，这两步的流程是相对复杂的。需要判断用户抽奖了几次，对于不同次数会限定是否能获得某个奖品，同时还有库存的扣减，如果库存不足或者不满足n次抽奖得到某个奖品，则会进行兜底</li> <li>这就是一个树规则的交叉流程，所以使用了组合模式构建一颗规则树，并通过数据库表的动态配置决定在抽奖流程中的后续的流程要如何进行</li></ul> <div class="custom-block tip"><p class="custom-block-title">面试提问2</p> <p>规则引擎的设计目的</p></div> <ul><li>背景：这是一个基于降低重复编码和提高可维护性的，并需要符合当前项目诉求的，同时不过渡的设计和减少运维成本的前提下，在技术调研后所做的微型规则引擎设计实现</li> <li>解决场景：主要作用是解决抽奖业务场景中对个性化运营诉求的处理，如抽奖N次解锁等规则的可配置化的交叉使用</li> <li>设计：基于这样的情况，此规则引擎的设计是一个二叉树判断，实现手段运用到了组合模式、工厂模式等。并为了便于维护和使用，进行了库表对二叉树的抽象设计，树根、节点、子叶，映射为二叉树编码的相关属性信息。同时，也可以基于这样的库表做前端页面的托拉拽配置操作，降低运营成本</li></ul> <h2 id="滑块锁设计"><a href="#滑块锁设计" class="header-anchor">#</a> 滑块锁设计</h2> <ul><li><p>简历描述：基于抽奖业务的并发场景，同时为了保证不超卖，在设计奖品库存扣减方面，从数据库行级锁优化到Redis Key加锁，再优化到Redis滑块锁，即采用Redis Decr分段消费和加锁兜底的设计思路</p></li> <li><p>背景：对于库存集中扣减类的业务流程，是不能直接用数据库表抗的</p></li> <li><p>设计：</p> <ul><li>对于这样的秒杀场景，我们一般都是使用 redis 缓存来处理库存，它只要不超卖就可以</li> <li>但也确保一点，不要用一条key加锁和等待释放的方式来处理，这样的效率依然是很低的</li> <li>所以我们要尽可能的考虑分摊竞争，达到无锁化才是分布式架构设计的核心</li></ul></li> <li><p>实现：</p> <ul><li>对于库存节点的操作，开发 decr 方式扣减库存。decr 是原子操作，效率非常高
<ul><li>setnx 加锁是一种兜底手段，避免后续有库存的恢复</li></ul></li></ul></li> <li><p>实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token comment">// 	Redisson的decr</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">decr</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redissonClient<span class="token punctuation">.</span><span class="token function">getAtomicLong</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	

	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">subtractionAwardStock</span><span class="token punctuation">(</span><span class="token class-name">String</span> cacheKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> surplus <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>surplus <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 库存小于0，恢复为0个</span>
            redisService<span class="token punctuation">.</span><span class="token function">setAtomicLong</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 1. 按照cacheKey decr 后的值，如 99、98、97 和 key 组成为库存锁的key进行使用。</span>
        <span class="token comment">// 2. 加锁为了兜底，如果后续有恢复库存，手动处理等，也不会超卖。因为所有的可用库存key，都被加锁了</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> cacheKey <span class="token operator">+</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">UNDERLINE</span> <span class="token operator">+</span> surplus<span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">setNx</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;策略奖品库存加锁失败 {}&quot;</span><span class="token punctuation">,</span> lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> lock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// Redisson的setNx</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">setNx</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redissonClient<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div></li></ul> <div class="custom-block note"><p class="custom-block-title">滑块锁讲解</p></div> <ul><li>滑块锁的核心是去竞态，即采用分段/滑块/无锁化处理，避免独占影响系统的响应性能</li></ul> <p><img src="https://jsd.onmicrosoft.cn/gh/xizhounanfeng/blogImg/setNx.jpg" alt=""></p> <ul><li>既然decr是原子操作，为什么还要加setNx锁
<ul><li>加锁是兜底，防止出现decr不对的情况
<ul><li>在 redis 集群模式下，decr 请求操作也可能<code>在请求时发生网络抖动</code>或者<code>超时返回</code>。这个时候decr有可能成功，也有可能失败。可能是请求超时，也可能是请求完的应答超时。那么decr 的值可能就不准【实际使用中10万次，可能会有10万零1和不足10万】。那么为了这样一个临界状态的可靠性，所以添加 setNx 加锁只有成功和失败
<ul><li>A用户执行decr请求的时候成功了，响应的时候，网络发生了抖动，所以实际上A用户自增成功。那同时B用户执行decr没有发生抖动，这个时候就会超卖。decr是没有事务性的，并不能保证安全，加了setNx也只是为了兜底而已</li></ul></li> <li>setNx 因为是<code>非独占锁</code>，所以<code>key不存在释放</code>。但是setNx 的 key 过期时间可以<code>优化为活动的有效期时间为结束</code> <ul><li>锁的颗粒度在于一个用户一个锁的key，所以没有个人释放再需要被让别人抢占的需要，因为这不是独占锁。所以锁的key可以设置活动结束后释放</li> <li>独占锁，其实你永远也不好把握释放时间，因为秒杀都是瞬态的，释放的晚了活动用户都走了，释放的早了，流程可能还没处理完</li></ul></li> <li>集群主从切换，或者活动出问题的时候恢复库存。如果恢复的 decr 值多了，那么有 setNx 锁拦截后，会更加可靠</li> <li>关于库存恢复，一般这类抽奖都是瞬态的，且redis集群非常稳定,所以很少有需要恢复库存。
<ul><li>如果需要恢复库存，那么是把失败的秒杀decr对应的值的key，加入到待消费队列中。等整体库存消耗后，开始消耗队列库存</li></ul></li></ul></li></ul></li> <li>假如一个用户在他自己的那个锁上失败了，导致锁无法被释放，那这个sku上的锁就一直被占着，是使用任务这种补偿机制去释放吗?
<ul><li>用sku+库存占用编号</li> <li>自己的锁失败，用户进来会拿到新的编号加锁</li> <li>失败的锁可以由任务处理</li> <li>任务处理的补偿其实不太可能作为秒杀的库存即时性恢复了，因为一般秒杀也就十几秒就结束了，所以只能当作最后捡漏</li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">面试提问</p> <p>抽奖是一种瞬时峰值很高的业务场景，那么对于抽中奖品后的库存扣减是如何操作的？</p></div> <ul><li>为了避免库存扣减直接更新库表的行级锁，而导致大量的用户进行等待状态。所以把数据库表的库存同步到 Redis 缓存中，在通过 decr 扣减的方式进行消费，同时为了确保在临界状态、库存恢复、异常处理等情况下不超卖，而对每一条产生从 incr 值，与抽奖的策略ID组合一个key，进行 setnx 加锁兜底，来保证不超卖</li></ul> <h2 id="异步更新库存"><a href="#异步更新库存" class="header-anchor">#</a> 异步更新库存</h2> <ul><li>简历描述：鉴于抽奖业务的瞬时峰值流量高的特点，为减轻数据库压力，采用MQ消息组件、XXL-JOB 分布式任务调度更新库存</li> <li>设计：库存消耗完以后，还需要更新库表的数据量。但这会也不能随着用户消耗奖品库存的速率，对数据库表执行扣减操作。所以通过 MQ消息组件、XXL-JOB 分布式任务调度，缓慢消耗队列数据来更新库表数据变化</li></ul> <div class="custom-block tip"><p class="custom-block-title">面试提问1</p> <p>对于数据库和Redis的一致性是怎么解决的？</p></div> <ul><li>第1个手段：每次消费decr值，写入MQ，趋势更新数据库数据 --&gt; 最终一致</li> <li>第2个手段：decr 库存值消耗为0时，发送MQ，更新最终数据库库存。（可能不准，比如decr值消耗中，少卖的情况）</li> <li>第3个手段：活动到期后，通过任务扫描活动产生订单量，校准库存</li></ul> <div class="custom-block tip"><p class="custom-block-title">面试提问2</p> <p>秒杀业务可能会出现的问题，出现的原因</p></div> <ul><li>不可能出现超卖。保证点：<code>decr 值的限制</code> 、<code>对每个key加锁的兜底设计</code>，确保不会超卖</li> <li>可能出现少卖
<ul><li>核心原因：因为 decr 操作和数据库操作不是是一个事务，有可能库存扣减完了，但最终操作库失败 --&gt; 则该库存丢失，导致少卖</li> <li>一般不会对少卖做过多的流程。若想管理，把少卖的库存异常，加入单独的 MQ 队列来重新消费</li></ul></li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2024-2024
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><canvas id="vuepress-canvas-cursor"></canvas><div id="goTop" class="hide-cat" data-v-bf92849a></div><!----><div></div><div></div></div></div>
    <script src="/assets/js/app.fc6a2803.js" defer></script><script src="/assets/js/2.5f34bf74.js" defer></script><script src="/assets/js/18.8e205241.js" defer></script><script src="/assets/js/8.3f2feba3.js" defer></script>
  </body>
</html>
